<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>资产盘点表 - 固定资产管理系统</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #1890ff;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .header a {
            color: white;
            text-decoration: none;
            background-color: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .header a:hover {
            background-color: rgba(255,255,255,0.3);
        }
        .tabs {
            display: flex;
            background-color: white;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            color: #666;
            transition: all 0.3s;
        }
        .tab.active {
            background-color: #1890ff;
            color: white;
        }
        .tab-content {
            background-color: white;
            padding: 20px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-container {
            margin-bottom: 20px;
        }
        .form-row {
            display: flex;
            margin-bottom: 15px;
            gap: 15px;
        }
        .form-group {
            flex: 1;
            min-width: 200px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
        input, select, button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        select {
            cursor: pointer;
        }
        button {
            background-color: #1890ff;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #40a9ff;
        }
        .btn-secondary {
            background-color: #52c41a;
        }
        .btn-secondary:hover {
            background-color: #73d13d;
        }
        .btn-danger {
            background-color: #ff4d4f;
        }
        .btn-danger:hover {
            background-color: #ff7875;
        }
        .btn-warning {
            background-color: #faad14;
        }
        .btn-warning:hover {
            background-color: #ffc53d;
        }
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn-group button {
            flex: 1;
        }
        .search-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }
        .search-container input {
            flex: 1;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        th {
            background-color: #fafafa;
            font-weight: 600;
            color: #333;
        }
        tr:hover {
            background-color: #fafafa;
        }
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        .alert-success {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        .alert-error {
            background-color: #fff2f0;
            border: 1px solid #ffccc7;
            color: #ff4d4f;
        }
        .alert-warning {
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            color: #fa8c16;
        }
        .hidden {
            display: none;
        }
        #fileInput {
            display: none;
        }
        .export-btn {
            margin-top: 20px;
        }
        .status-normal {
            color: #52c41a;
            font-weight: 500;
        }
        .status-missing {
            color: #ff4d4f;
            font-weight: 500;
        }
        .status-extra {
            color: #fa8c16;
            font-weight: 500;
        }
        .status-different {
            color: #722ed1;
            font-weight: 500;
        }
        .inventory-summary {
            background-color: #f0f5ff;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .summary-title {
            font-weight: 600;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .modal-header h3 {
            margin: 0;
        }
        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        .close-modal:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>资产盘点表</h1>
            <a href="index.html">返回资管首页</a>
        </div>

        <div class="tabs">
            <button class="tab" onclick="switchTab(0)">盘点计划</button>
            <button class="tab" onclick="switchTab(1)">盘点执行</button>
            <button class="tab active" onclick="switchTab(2)">盘点分析</button>
        </div>

        <!-- 盘点计划 -->
        <div class="tab-content" id="tab0">
            <div class="form-container">
                <h3>创建盘点计划</h3>
                <div id="alertMessage" class="alert hidden"></div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="planName">计划名称 <span style="color: red;">*</span></label>
                        <input type="text" id="planName" placeholder="请输入盘点计划名称（如：2024年1月季度盘点）">
                    </div>
                    <div class="form-group">
                        <label for="planDate">盘点日期 <span style="color: red;">*</span></label>
                        <input type="date" id="planDate">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="planType">盘点类型 <span style="color: red;">*</span></label>
                        <select id="planType">
                            <option value="full">全面盘点</option>
                            <option value="partial">局部盘点</option>
                            <option value="cycle">循环盘点</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="planDepartment">负责部门 <span style="color: red;">*</span></label>
                        <input type="text" id="planDepartment" placeholder="请输入负责部门">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="planPersonnel">盘点人员 <span style="color: red;">*</span></label>
                        <input type="text" id="planPersonnel" placeholder="请输入盘点人员姓名，多个用逗号分隔">
                    </div>
                    <div class="form-group">
                        <label for="planStatus">状态</label>
                        <select id="planStatus">
                            <option value="draft">草稿</option>
                            <option value="active">执行中</option>
                            <option value="completed">已完成</option>
                            <option value="cancelled">已取消</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="planDescription">备注说明</label>
                    <textarea id="planDescription" rows="3" placeholder="请输入备注说明" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; box-sizing: border-box; font-family: inherit;"></textarea>
                </div>

                <div class="btn-group">
                    <button onclick="saveInventoryPlan()">保存计划</button>
                    <button type="button" onclick="resetPlanForm()">重置表单</button>
                    <button type="button" class="btn-warning" onclick="importFromAssets()">从资产表导入</button>
                </div>
            </div>

            <div class="plans-table">
                <h3>盘点计划列表</h3>
                <div class="search-container">
                    <input type="text" id="searchPlanInput" placeholder="搜索计划名称">
                    <button onclick="searchPlans()">搜索</button>
                    <button type="button" onclick="clearPlanSearch()">清除</button>
                </div>

                <table id="inventoryPlansTable">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="selectAllPlans"></th>
                            <th>计划名称</th>
                            <th>盘点日期</th>
                            <th>盘点类型</th>
                            <th>负责部门</th>
                            <th>盘点人员</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryPlansTableBody">
                        <!-- 数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>

                <button class="btn-danger export-btn" onclick="deleteSelectedPlans()">删除选中计划</button>
            </div>
        </div>

        <!-- 盘点执行 -->
        <div class="tab-content" id="tab1">
            <div class="form-container">
                <h3>执行盘点</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="selectPlan">选择盘点计划 <span style="color: red;">*</span></label>
                        <select id="selectPlan" onchange="loadPlanDetails()">
                            <option value="">请选择计划</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="scanMethod">盘点方式</label>
                        <select id="scanMethod">
                            <option value="manual">手动录入</option>
                            <option value="batch">批量录入</option>
                        </select>
                    </div>
                </div>

                <div id="planDetails" class="inventory-summary hidden">
                    <div class="summary-item">
                        <span class="summary-title">计划名称：</span>
                        <span id="planDetailName">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">盘点日期：</span>
                        <span id="planDetailDate">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">盘点类型：</span>
                        <span id="planDetailType">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">负责部门：</span>
                        <span id="planDetailDepartment">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">盘点人员：</span>
                        <span id="planDetailPersonnel">-</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button onclick="startInventory()">开始盘点</button>
                    <button type="button" class="btn-secondary" onclick="importInventoryData()">导入盘点数据</button>
                    <button type="button" class="btn-danger" onclick="finishInventory()">完成盘点</button>
                </div>
            </div>

            <div id="inventoryExecution" class="hidden">
                <h3>正在盘点 - <span id="currentPlanName"></span></h3>
                <div class="search-container">
                    <input type="text" id="inventorySearchInput" placeholder="搜索资产编码/名称">
                    <button onclick="searchInventoryItems()">搜索</button>
                    <button type="button" onclick="clearInventorySearch()">清除</button>
                </div>

                <table id="inventoryTable">
                    <thead>
                        <tr>
                            <th>资产编码</th>
                            <th>资产名称</th>
                            <th>资产类别</th>
                            <th>预期数量</th>
                            <th>实际数量</th>
                            <th>存放位置</th>
                            <th>盘点状态</th>
                            <th>备注</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- 盘点数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>

                <div class="btn-group">
                    <button type="button" onclick="markAllFound()">全部标记为已找到</button>
                    <button type="button" class="btn-secondary" onclick="exportInventoryTemplate()">导出盘点模板</button>
                </div>
            </div>
        </div>

        <!-- 盘点分析 -->
        <div class="tab-content active" id="tab2">
            <div class="form-container">
                <h3>盘点结果分析</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="selectCompletedPlan">选择已完成的盘点计划 <span style="color: red;">*</span></label>
                        <select id="selectCompletedPlan" onchange="loadAnalysisData()">
                            <option value="">请选择计划</option>
                        </select>
                    </div>
                </div>

                <div id="analysisSummary" class="inventory-summary hidden">
                    <h4>盘点结果汇总</h4>
                    <div class="summary-item">
                        <span class="summary-title">计划名称：</span>
                        <span id="analysisPlanName">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">盘点日期：</span>
                        <span id="analysisPlanDate">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">应盘总数：</span>
                        <span id="totalExpected">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">实际盘点：</span>
                        <span id="totalActual">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">盘盈数量：</span>
                        <span id="totalSurplus" class="status-extra">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">盘亏数量：</span>
                        <span id="totalShortage" class="status-missing">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-title">盘准确率：</span>
                        <span id="accuracyRate">0%</span>
                    </div>
                </div>

                <div class="btn-group">
                    <button type="button" onclick="exportAnalysisReport()">导出分析报告</button>
                    <button type="button" class="btn-secondary" onclick="viewDiscrepancies()">查看差异明细</button>
                </div>
            </div>

            <div id="analysisResult" class="hidden">
                <h3>盘点结果明细</h3>
                <table id="analysisTable">
                    <thead>
                        <tr>
                            <th>资产编码</th>
                            <th>资产名称</th>
                            <th>资产类别</th>
                            <th>预期数量</th>
                            <th>实际数量</th>
                            <th>差异数量</th>
                            <th>盘点状态</th>
                            <th>处理状态</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody id="analysisTableBody">
                        <!-- 分析数据将通过JavaScript动态生成 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 处理差异模态框 -->
    <div id="handleDiscrepancyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>处理盘点差异</h3>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div class="form-container">
                <div id="assetDiscrepancyInfo" style="margin-bottom: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 4px;">
                    <!-- 资产差异信息将显示在这里 -->
                </div>
                <div class="form-group">
                    <label for="discrepancyReason">差异原因 <span style="color: red;">*</span></label>
                    <textarea id="discrepancyReason" rows="3" placeholder="请输入差异原因" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; box-sizing: border-box; font-family: inherit;"></textarea>
                </div>
                <div class="form-group">
                    <label for="discrepancySolution">处理方案 <span style="color: red;">*</span></label>
                    <textarea id="discrepancySolution" rows="3" placeholder="请输入处理方案" style="width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px; font-size: 14px; box-sizing: border-box; font-family: inherit;"></textarea>
                </div>
                <div class="form-group">
                    <label for="discrepancyHandler">处理人</label>
                    <input type="text" id="discrepancyHandler" placeholder="请输入处理人姓名">
                </div>
                <div class="form-group">
                    <label for="discrepancyStatus">处理状态</label>
                    <select id="discrepancyStatus">
                        <option value="pending">待处理</option>
                        <option value="processing">处理中</option>
                        <option value="resolved">已解决</option>
                        <option value="unresolved">未解决</option>
                    </select>
                </div>
                <button onclick="saveDiscrepancyHandling()">保存处理结果</button>
            </div>
        </div>
    </div>

    <script>
        // 切换标签页
        function switchTab(index) {
            // 隐藏所有标签内容
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));
            
            // 移除所有标签的活跃状态
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // 显示选中的标签内容
            tabContents[index].classList.add('active');
            tabs[index].classList.add('active');
            
            // 根据选中的标签页加载相应数据
            if (index === 0) {
                loadInventoryPlans();
            } else if (index === 1) {
                loadPlansToSelector();
                document.getElementById('inventoryExecution').classList.add('hidden');
            } else if (index === 2) {
                loadCompletedPlansToSelector();
                document.getElementById('analysisSummary').classList.add('hidden');
                document.getElementById('analysisResult').classList.add('hidden');
            }
        }

        // 显示提示信息
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            
            setTimeout(() => {
                alertDiv.className = 'alert hidden';
            }, 3000);
        }

        // 重置计划表单
        function resetPlanForm() {
            document.getElementById('planName').value = '';
            document.getElementById('planDate').value = '';
            document.getElementById('planType').value = 'full';
            document.getElementById('planDepartment').value = '';
            document.getElementById('planPersonnel').value = '';
            document.getElementById('planStatus').value = 'draft';
            document.getElementById('planDescription').value = '';
        }

        // 保存盘点计划
        function saveInventoryPlan() {
            // 获取表单数据
            const planName = document.getElementById('planName').value.trim();
            const planDate = document.getElementById('planDate').value;
            const planType = document.getElementById('planType').value;
            const planDepartment = document.getElementById('planDepartment').value.trim();
            const planPersonnel = document.getElementById('planPersonnel').value.trim();
            const planStatus = document.getElementById('planStatus').value;
            const planDescription = document.getElementById('planDescription').value.trim();
            
            // 验证必填字段
            if (!planName) {
                showAlert('请填写计划名称', 'error');
                return;
            }
            if (!planDate) {
                showAlert('请选择盘点日期', 'error');
                return;
            }
            if (!planDepartment) {
                showAlert('请填写负责部门', 'error');
                return;
            }
            if (!planPersonnel) {
                showAlert('请填写盘点人员', 'error');
                return;
            }
            
            // 从本地存储获取现有盘点计划数据
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            
            // 检查计划名称是否已存在
            const editingId = localStorage.getItem('editingInventoryPlanId');
            const existingPlan = inventoryPlans.find(plan => 
                plan.planName === planName && plan.id !== editingId
            );
            
            if (existingPlan) {
                showAlert('计划名称已存在，请使用不同的名称', 'error');
                return;
            }
            
            // 创建盘点计划对象
            const inventoryPlan = {
                planName,
                planDate,
                planType,
                planDepartment,
                planPersonnel,
                planStatus,
                planDescription,
                createdAt: editingId ? inventoryPlans.find(p => p.id === editingId)?.createdAt || new Date().toISOString() : new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                id: editingId || Date.now().toString()
            };
            
            if (editingId) {
                // 更新现有计划
                const index = inventoryPlans.findIndex(plan => plan.id === editingId);
                inventoryPlans[index] = inventoryPlan;
                localStorage.removeItem('editingInventoryPlanId');
                showAlert('盘点计划更新成功');
            } else {
                // 添加新计划
                inventoryPlans.push(inventoryPlan);
                showAlert('盘点计划保存成功');
            }
            
            // 保存回本地存储
            localStorage.setItem('inventoryPlans', JSON.stringify(inventoryPlans));
            
            // 重置表单
            resetPlanForm();
            
            // 重新加载计划列表
            loadInventoryPlans();
        }

        // 加载盘点计划数据
        function loadInventoryPlans(searchTerm = '') {
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const tableBody = document.getElementById('inventoryPlansTableBody');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 过滤搜索结果
            const filteredPlans = inventoryPlans.filter(plan => {
                if (!searchTerm) return true;
                return plan.planName.includes(searchTerm);
            });
            
            // 如果没有数据
            if (filteredPlans.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">暂无盘点计划</td></tr>';
                return;
            }
            
            // 排序：最新创建的在前
            filteredPlans.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            // 填充表格
            filteredPlans.forEach(plan => {
                const statusMap = {
                    'draft': '草稿',
                    'active': '执行中',
                    'completed': '已完成',
                    'cancelled': '已取消'
                };
                const typeMap = {
                    'full': '全面盘点',
                    'partial': '局部盘点',
                    'cycle': '循环盘点'
                };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" class="plan-checkbox" data-id="${plan.id}"></td>
                    <td>${plan.planName}</td>
                    <td>${plan.planDate}</td>
                    <td>${typeMap[plan.planType]}</td>
                    <td>${plan.planDepartment}</td>
                    <td>${plan.planPersonnel}</td>
                    <td>${statusMap[plan.planStatus]}</td>
                    <td>${new Date(plan.createdAt).toLocaleString()}</td>
                    <td>
                        <button onclick="editInventoryPlan('${plan.id}')" style="padding: 4px 8px; font-size: 12px;">编辑</button>
                        <button onclick="deleteInventoryPlan('${plan.id}')" style="padding: 4px 8px; font-size: 12px; background-color: #ff4d4f;">删除</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 搜索盘点计划
        function searchPlans() {
            const searchTerm = document.getElementById('searchPlanInput').value.trim();
            loadInventoryPlans(searchTerm);
        }

        // 清除搜索
        function clearPlanSearch() {
            document.getElementById('searchPlanInput').value = '';
            loadInventoryPlans();
        }

        // 编辑盘点计划
        function editInventoryPlan(id) {
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const plan = inventoryPlans.find(p => p.id === id);
            
            if (plan) {
                // 填充表单
                document.getElementById('planName').value = plan.planName;
                document.getElementById('planDate').value = plan.planDate;
                document.getElementById('planType').value = plan.planType;
                document.getElementById('planDepartment').value = plan.planDepartment;
                document.getElementById('planPersonnel').value = plan.planPersonnel;
                document.getElementById('planStatus').value = plan.planStatus;
                document.getElementById('planDescription').value = plan.planDescription || '';
                
                // 切换到计划标签页（如果不在的话）
                if (!document.getElementById('tab0').classList.contains('active')) {
                    switchTab(0);
                }
                
                // 滚动到表单顶部
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // 提示用户正在编辑
                showAlert(`正在编辑盘点计划：${plan.planName}`);
                
                // 保存编辑状态
                localStorage.setItem('editingInventoryPlanId', id);
            }
        }

        // 删除单个盘点计划
        function deleteInventoryPlan(id) {
            if (confirm('确定要删除这个盘点计划吗？删除后无法恢复。')) {
                let inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
                inventoryPlans = inventoryPlans.filter(plan => plan.id !== id);
                localStorage.setItem('inventoryPlans', JSON.stringify(inventoryPlans));
                
                showAlert('盘点计划删除成功');
                loadInventoryPlans();
            }
        }

        // 删除选中盘点计划
        function deleteSelectedPlans() {
            const checkboxes = document.querySelectorAll('.plan-checkbox:checked');
            if (checkboxes.length === 0) {
                showAlert('请先选择要删除的盘点计划', 'error');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${checkboxes.length} 个盘点计划吗？删除后无法恢复。`)) {
                let inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
                const planIds = Array.from(checkboxes).map(cb => cb.dataset.id);
                inventoryPlans = inventoryPlans.filter(plan => !planIds.includes(plan.id));
                localStorage.setItem('inventoryPlans', JSON.stringify(inventoryPlans));
                
                showAlert(`成功删除 ${checkboxes.length} 个盘点计划`);
                loadInventoryPlans();
            }
        }

        // 全选/取消全选
        document.getElementById('selectAllPlans').addEventListener('change', function() {
            const checkboxes = document.querySelectorAll('.plan-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
            });
        });

        // 从资产表导入
        function importFromAssets() {
            const assetMainData = JSON.parse(localStorage.getItem('assetMainData') || '[]');
            const fixedAssetData = JSON.parse(localStorage.getItem('fixedAssetData') || '[]');
            const lowValueData = JSON.parse(localStorage.getItem('lowValueData') || '[]');
            
            if (assetMainData.length === 0 && fixedAssetData.length === 0 && lowValueData.length === 0) {
                showAlert('没有可导入的资产数据，请先在资产表中添加数据', 'error');
                return;
            }
            
            // 合并所有资产数据
            const allAssets = [];
            
            // 处理资产主表数据
            assetMainData.forEach(asset => {
                allAssets.push({
                    assetCode: asset.assetCode || '',
                    assetName: asset.assetName || '',
                    assetCategory: asset.assetCategory || '',
                    location: asset.location || '',
                    expectedQuantity: 1,
                    actualQuantity: 0,
                    status: 'missing',
                    remarks: ''
                });
            });
            
            // 处理固定资产数据
            fixedAssetData.forEach(asset => {
                allAssets.push({
                    assetCode: asset.assetCode || '',
                    assetName: asset.assetName || '',
                    assetCategory: '固定资产',
                    location: asset.location || '',
                    expectedQuantity: 1,
                    actualQuantity: 0,
                    status: 'missing',
                    remarks: ''
                });
            });
            
            // 处理低值易耗品数据
            lowValueData.forEach(asset => {
                allAssets.push({
                    assetCode: asset.assetCode || '',
                    assetName: asset.assetName || '',
                    assetCategory: '低值易耗品',
                    location: asset.location || '',
                    expectedQuantity: parseInt(asset.quantity) || 0,
                    actualQuantity: 0,
                    status: 'missing',
                    remarks: ''
                });
            });
            
            // 创建新的盘点计划名称
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('planName').value = `${today} 自动生成盘点计划`;
            document.getElementById('planDate').value = today;
            document.getElementById('planType').value = 'full';
            
            showAlert(`成功导入 ${allAssets.length} 条资产数据，请完善盘点计划信息并保存`, 'success');
        }

        // 加载盘点计划到选择器
        function loadPlansToSelector() {
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const planSelect = document.getElementById('selectPlan');
            
            // 清空选择器（保留第一个选项）
            planSelect.innerHTML = '<option value="">请选择计划</option>';
            
            // 添加计划选项
            inventoryPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.planName} (${plan.planDate})`;
                planSelect.appendChild(option);
            });
        }

        // 加载计划详情
        function loadPlanDetails() {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) {
                document.getElementById('planDetails').classList.add('hidden');
                return;
            }
            
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const plan = inventoryPlans.find(p => p.id === planId);
            
            if (plan) {
                const typeMap = {
                    'full': '全面盘点',
                    'partial': '局部盘点',
                    'cycle': '循环盘点'
                };
                
                document.getElementById('planDetailName').textContent = plan.planName;
                document.getElementById('planDetailDate').textContent = plan.planDate;
                document.getElementById('planDetailType').textContent = typeMap[plan.planType];
                document.getElementById('planDetailDepartment').textContent = plan.planDepartment;
                document.getElementById('planDetailPersonnel').textContent = plan.planPersonnel;
                
                document.getElementById('planDetails').classList.remove('hidden');
            }
        }

        // 开始盘点
        function startInventory() {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) {
                showAlert('请选择一个盘点计划', 'error');
                return;
            }
            
            // 获取盘点计划
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const plan = inventoryPlans.find(p => p.id === planId);
            
            if (!plan) {
                showAlert('盘点计划不存在', 'error');
                return;
            }
            
            // 更新计划状态为执行中
            plan.planStatus = 'active';
            localStorage.setItem('inventoryPlans', JSON.stringify(inventoryPlans));
            
            // 生成盘点数据
            generateInventoryData(planId);
            
            // 显示盘点执行界面
            document.getElementById('currentPlanName').textContent = plan.planName;
            document.getElementById('inventoryExecution').classList.remove('hidden');
            
            // 加载盘点数据
            loadInventoryData();
            
            showAlert(`开始执行盘点计划：${plan.planName}`, 'success');
        }

        // 生成盘点数据
        function generateInventoryData(planId) {
            // 从各资产表获取数据
            const assetMainData = JSON.parse(localStorage.getItem('assetMainData') || '[]');
            const fixedAssetData = JSON.parse(localStorage.getItem('fixedAssetData') || '[]');
            const lowValueData = JSON.parse(localStorage.getItem('lowValueData') || '[]');
            
            // 合并所有资产数据
            const inventoryItems = [];
            
            // 处理资产主表数据
            assetMainData.forEach(asset => {
                inventoryItems.push({
                    assetCode: asset.assetCode || '',
                    assetName: asset.assetName || '',
                    assetCategory: asset.assetCategory || '',
                    location: asset.location || '',
                    expectedQuantity: 1,
                    actualQuantity: 0,
                    status: 'missing',
                    remarks: ''
                });
            });
            
            // 处理固定资产数据
            fixedAssetData.forEach(asset => {
                inventoryItems.push({
                    assetCode: asset.assetCode || '',
                    assetName: asset.assetName || '',
                    assetCategory: '固定资产',
                    location: asset.location || '',
                    expectedQuantity: 1,
                    actualQuantity: 0,
                    status: 'missing',
                    remarks: ''
                });
            });
            
            // 处理低值易耗品数据
            lowValueData.forEach(asset => {
                inventoryItems.push({
                    assetCode: asset.assetCode || '',
                    assetName: asset.assetName || '',
                    assetCategory: '低值易耗品',
                    location: asset.location || '',
                    expectedQuantity: parseInt(asset.quantity) || 0,
                    actualQuantity: 0,
                    status: 'missing',
                    remarks: ''
                });
            });
            
            // 创建盘点数据对象
            const inventoryData = {
                planId,
                items: inventoryItems,
                startTime: new Date().toISOString(),
                endTime: null,
                status: 'in-progress'
            };
            
            // 保存到本地存储
            localStorage.setItem(`inventoryData_${planId}`, JSON.stringify(inventoryData));
        }

        // 加载盘点数据
        function loadInventoryData(searchTerm = '') {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) return;
            
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            const tableBody = document.getElementById('inventoryTableBody');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 过滤搜索结果
            const filteredItems = inventoryData.items.filter(item => {
                if (!searchTerm) return true;
                return item.assetCode.includes(searchTerm) || item.assetName.includes(searchTerm);
            });
            
            // 如果没有数据
            if (filteredItems.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center;">暂无盘点数据</td></tr>';
                return;
            }
            
            // 填充表格
            filteredItems.forEach((item, index) => {
                const statusMap = {
                    'normal': { text: '正常', className: 'status-normal' },
                    'missing': { text: '缺失', className: 'status-missing' },
                    'extra': { text: '盘盈', className: 'status-extra' },
                    'different': { text: '数量不符', className: 'status-different' }
                };
                
                const status = statusMap[item.status] || { text: '未盘点', className: '' };
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.assetCode}</td>
                    <td>${item.assetName}</td>
                    <td>${item.assetCategory}</td>
                    <td>${item.expectedQuantity}</td>
                    <td>
                        <input type="number" min="0" value="${item.actualQuantity}" 
                               onchange="updateActualQuantity(${index}, this.value)" 
                               style="width: 80px; padding: 4px;">
                    </td>
                    <td>${item.location}</td>
                    <td class="${status.className}">${status.text}</td>
                    <td>
                        <input type="text" value="${item.remarks || ''}" 
                               onchange="updateItemRemarks(${index}, this.value)" 
                               style="width: 120px; padding: 4px;">
                    </td>
                    <td>
                        <button onclick="markFound(${index})" style="padding: 4px 8px; font-size: 12px; background-color: #52c41a;">标记已找到</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // 搜索盘点项目
        function searchInventoryItems() {
            const searchTerm = document.getElementById('inventorySearchInput').value.trim();
            loadInventoryData(searchTerm);
        }

        // 清除盘点搜索
        function clearInventorySearch() {
            document.getElementById('inventorySearchInput').value = '';
            loadInventoryData();
        }

        // 更新实际数量
        function updateActualQuantity(index, value) {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) return;
            
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            const item = inventoryData.items[index];
            
            if (item) {
                item.actualQuantity = parseInt(value) || 0;
                
                // 更新状态
                if (item.actualQuantity === 0) {
                    item.status = 'missing';
                } else if (item.actualQuantity === item.expectedQuantity) {
                    item.status = 'normal';
                } else if (item.actualQuantity > item.expectedQuantity) {
                    item.status = 'extra';
                } else {
                    item.status = 'different';
                }
                
                localStorage.setItem(`inventoryData_${planId}`, JSON.stringify(inventoryData));
                loadInventoryData(); // 重新加载以更新状态显示
            }
        }

        // 更新项目备注
        function updateItemRemarks(index, value) {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) return;
            
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            
            if (inventoryData.items[index]) {
                inventoryData.items[index].remarks = value.trim();
                localStorage.setItem(`inventoryData_${planId}`, JSON.stringify(inventoryData));
            }
        }

        // 标记为已找到
        function markFound(index) {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) return;
            
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            const item = inventoryData.items[index];
            
            if (item) {
                item.actualQuantity = item.expectedQuantity;
                item.status = 'normal';
                localStorage.setItem(`inventoryData_${planId}`, JSON.stringify(inventoryData));
                loadInventoryData();
            }
        }

        // 全部标记为已找到
        function markAllFound() {
            if (confirm('确定要将所有资产标记为已找到吗？')) {
                const planId = document.getElementById('selectPlan').value;
                if (!planId) return;
                
                const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
                
                inventoryData.items.forEach(item => {
                    item.actualQuantity = item.expectedQuantity;
                    item.status = 'normal';
                });
                
                localStorage.setItem(`inventoryData_${planId}`, JSON.stringify(inventoryData));
                loadInventoryData();
                showAlert('已将所有资产标记为已找到', 'success');
            }
        }

        // 导入盘点数据
        function importInventoryData() {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) {
                showAlert('请先选择一个盘点计划', 'error');
                return;
            }
            
            // 创建文件输入元素
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls,.csv';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // 这里简化处理，实际项目中应该使用SheetJS等库处理Excel/CSV文件
                alert('导入功能需要使用SheetJS等库实现完整的文件解析，此处仅作演示');
                // 在实际项目中，可以使用如下方式处理：
                // const reader = new FileReader();
                // reader.onload = function(e) {
                //     const data = new Uint8Array(e.target.result);
                //     const workbook = XLSX.read(data, { type: 'array' });
                //     // 处理Excel数据并更新到localStorage
                // };
                // reader.readAsArrayBuffer(file);
            };
            
            fileInput.click();
        }

        // 导出盘点模板
        function exportInventoryTemplate() {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) {
                showAlert('请先选择一个盘点计划', 'error');
                return;
            }
            
            // 构建CSV内容（即使没有数据也生成表头）
            let csvContent = '资产编码,资产名称,资产类别,存放位置,预期数量,实际数量,备注\n';
            
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            
            if (inventoryData.items && inventoryData.items.length > 0) {
                inventoryData.items.forEach(item => {
                    csvContent += `${item.assetCode},${item.assetName},${item.assetCategory},${item.location},${item.expectedQuantity},,\n`;
                });
            }
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `盘点模板_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
            
            showAlert('盘点模板导出成功', 'success');
        }

        // 完成盘点
        function finishInventory() {
            const planId = document.getElementById('selectPlan').value;
            if (!planId) {
                showAlert('请先选择一个盘点计划', 'error');
                return;
            }
            
            if (!confirm('确定要完成盘点吗？完成后将无法修改盘点数据。')) {
                return;
            }
            
            // 更新盘点计划状态
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const planIndex = inventoryPlans.findIndex(p => p.id === planId);
            
            if (planIndex !== -1) {
                inventoryPlans[planIndex].planStatus = 'completed';
                localStorage.setItem('inventoryPlans', JSON.stringify(inventoryPlans));
                
                // 更新盘点数据
                const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
                inventoryData.endTime = new Date().toISOString();
                inventoryData.status = 'completed';
                localStorage.setItem(`inventoryData_${planId}`, JSON.stringify(inventoryData));
                
                document.getElementById('inventoryExecution').classList.add('hidden');
                showAlert('盘点已完成', 'success');
            }
        }

        // 加载已完成的计划到分析选择器
        function loadCompletedPlansToSelector() {
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const planSelect = document.getElementById('selectCompletedPlan');
            
            // 清空选择器（保留第一个选项）
            planSelect.innerHTML = '<option value="">请选择计划</option>';
            
            // 只添加已完成的计划
            const completedPlans = inventoryPlans.filter(plan => plan.planStatus === 'completed');
            
            completedPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                option.textContent = `${plan.planName} (${plan.planDate})`;
                planSelect.appendChild(option);
            });
        }

        // 加载分析数据
        function loadAnalysisData() {
            const planId = document.getElementById('selectCompletedPlan').value;
            if (!planId) {
                document.getElementById('analysisSummary').classList.add('hidden');
                document.getElementById('analysisResult').classList.add('hidden');
                return;
            }
            
            // 获取计划信息
            const inventoryPlans = JSON.parse(localStorage.getItem('inventoryPlans') || '[]');
            const plan = inventoryPlans.find(p => p.id === planId);
            
            if (!plan) {
                showAlert('盘点计划不存在', 'error');
                return;
            }
            
            // 获取盘点数据
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            
            // 计算统计数据
            const totalExpected = inventoryData.items.reduce((sum, item) => sum + item.expectedQuantity, 0);
            const totalActual = inventoryData.items.reduce((sum, item) => sum + item.actualQuantity, 0);
            
            let totalSurplus = 0;
            let totalShortage = 0;
            
            inventoryData.items.forEach(item => {
                const diff = item.actualQuantity - item.expectedQuantity;
                if (diff > 0) {
                    totalSurplus += diff;
                } else if (diff < 0) {
                    totalShortage += Math.abs(diff);
                }
            });
            
            const accuracyRate = totalExpected > 0 ? 
                Math.round(((totalExpected - totalShortage) / totalExpected) * 100) : 0;
            
            // 更新汇总信息
            document.getElementById('analysisPlanName').textContent = plan.planName;
            document.getElementById('analysisPlanDate').textContent = plan.planDate;
            document.getElementById('totalExpected').textContent = totalExpected;
            document.getElementById('totalActual').textContent = totalActual;
            document.getElementById('totalSurplus').textContent = totalSurplus;
            document.getElementById('totalShortage').textContent = totalShortage;
            document.getElementById('accuracyRate').textContent = `${accuracyRate}%`;
            
            // 显示汇总信息
            document.getElementById('analysisSummary').classList.remove('hidden');
            document.getElementById('analysisResult').classList.remove('hidden');
            
            // 更新明细表格
            updateAnalysisTable(inventoryData.items);
        }

        // 更新分析表格
        function updateAnalysisTable(items) {
            const tableBody = document.getElementById('analysisTableBody');
            
            // 清空表格
            tableBody.innerHTML = '';
            
            // 填充表格
            items.forEach(item => {
                const diff = item.actualQuantity - item.expectedQuantity;
                
                let status = '';
                let statusClass = '';
                
                if (diff === 0) {
                    status = '正常';
                    statusClass = 'status-normal';
                } else if (diff > 0) {
                    status = '盘盈';
                    statusClass = 'status-extra';
                } else {
                    status = '盘亏';
                    statusClass = 'status-missing';
                }
                
                // 获取差异处理状态（如果有）
                const discrepancyHandling = localStorage.getItem(`discrepancy_${item.assetCode}_${planId}`);
                const handlingStatus = discrepancyHandling ? JSON.parse(discrepancyHandling).status : '待处理';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.assetCode}</td>
                    <td>${item.assetName}</td>
                    <td>${item.assetCategory}</td>
                    <td>${item.expectedQuantity}</td>
                    <td>${item.actualQuantity}</td>
                    <td>${diff > 0 ? '+' : ''}${diff}</td>
                    <td class="${statusClass}">${status}</td>
                    <td>${handlingStatus}</td>
                    <td>${item.remarks || '-'}</td>
                `;
                
                // 如果有差异，添加处理按钮
                if (diff !== 0) {
                    const actionCell = document.createElement('td');
                    actionCell.innerHTML = `<button onclick="openDiscrepancyModal('${item.assetCode}', ${diff}, '${item.assetName}', ${item.expectedQuantity}, ${item.actualQuantity})" style="padding: 4px 8px; font-size: 12px;">处理</button>`;
                    row.appendChild(actionCell);
                } else {
                    const emptyCell = document.createElement('td');
                    row.appendChild(emptyCell);
                }
                
                tableBody.appendChild(row);
            });
        }

        // 导出分析报告
        function exportAnalysisReport() {
            const planId = document.getElementById('selectCompletedPlan').value;
            if (!planId) {
                showAlert('请先选择一个盘点计划', 'error');
                return;
            }
            
            // 构建CSV内容（即使没有数据也生成表头）
            let csvContent = '资产编码,资产名称,资产类别,预期数量,实际数量,差异数量,盘点状态,备注\n';
            
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            
            if (inventoryData.items && inventoryData.items.length > 0) {
                inventoryData.items.forEach(item => {
                    // 确保实际数量存在，避免计算错误
                    const actualQuantity = item.actualQuantity || 0;
                    const diff = actualQuantity - item.expectedQuantity;
                    let status = '';
                    
                    if (diff === 0) {
                        status = '正常';
                    } else if (diff > 0) {
                        status = '盘盈';
                    } else {
                        status = '盘亏';
                    }
                    
                    csvContent += `${item.assetCode},${item.assetName},${item.assetCategory},${item.expectedQuantity},${actualQuantity},${diff > 0 ? '+' : ''}${diff},${status},${item.remarks || ''}\n`;
                });
            }
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `盘点分析报告_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }, 100);
            
            showAlert('分析报告导出成功', 'success');
        }

        // 查看差异明细
        function viewDiscrepancies() {
            const planId = document.getElementById('selectCompletedPlan').value;
            if (!planId) {
                showAlert('请先选择一个盘点计划', 'error');
                return;
            }
            
            const inventoryData = JSON.parse(localStorage.getItem(`inventoryData_${planId}`) || '{"items":[]}');
            
            // 过滤出有差异的项目
            const discrepancies = inventoryData.items.filter(item => item.actualQuantity !== item.expectedQuantity);
            
            if (discrepancies.length === 0) {
                showAlert('没有发现盘点差异', 'success');
                return;
            }
            
            // 更新表格显示差异项目
            updateAnalysisTable(discrepancies);
            showAlert(`共发现 ${discrepancies.length} 项差异`, 'warning');
        }

        // 打开差异处理模态框
        function openDiscrepancyModal(assetCode, diff, assetName, expected, actual) {
            const modal = document.getElementById('handleDiscrepancyModal');
            const assetInfo = document.getElementById('assetDiscrepancyInfo');
            
            // 填充资产信息
            assetInfo.innerHTML = `
                <div>资产编码：${assetCode}</div>
                <div>资产名称：${assetName}</div>
                <div>预期数量：${expected}</div>
                <div>实际数量：${actual}</div>
                <div>差异数量：<span class="${diff > 0 ? 'status-extra' : 'status-missing'}">${diff > 0 ? '+' : ''}${diff}</span></div>
                <div>差异类型：<span class="${diff > 0 ? 'status-extra' : 'status-missing'}">${diff > 0 ? '盘盈' : '盘亏'}</span></div>
            `;
            
            // 保存当前处理的资产编码
            modal.dataset.assetCode = assetCode;
            modal.dataset.diff = diff;
            
            // 显示模态框
            modal.style.display = 'flex';
            
            // 检查是否已有处理记录
            const existingHandling = localStorage.getItem(`discrepancy_${assetCode}_${currentPlanId}`);
            if (existingHandling) {
                const handling = JSON.parse(existingHandling);
                document.getElementById('discrepancyReason').value = handling.reason || '';
                document.getElementById('discrepancySolution').value = handling.solution || '';
                document.getElementById('discrepancyHandler').value = handling.handler || '';
                document.getElementById('discrepancyStatus').value = handling.status || 'pending';
            } else {
                // 重置表单
                document.getElementById('discrepancyReason').value = '';
                document.getElementById('discrepancySolution').value = '';
                document.getElementById('discrepancyHandler').value = '';
                document.getElementById('discrepancyStatus').value = 'pending';
            }
        }

        // 关闭模态框
        function closeModal() {
            const modal = document.getElementById('handleDiscrepancyModal');
            modal.style.display = 'none';
        }

        // 保存差异处理结果
        function saveDiscrepancyHandling() {
            const modal = document.getElementById('handleDiscrepancyModal');
            const assetCode = modal.dataset.assetCode;
            const diff = parseInt(modal.dataset.diff);
            
            const reason = document.getElementById('discrepancyReason').value.trim();
            const solution = document.getElementById('discrepancySolution').value.trim();
            const handler = document.getElementById('discrepancyHandler').value.trim();
            const status = document.getElementById('discrepancyStatus').value;
            
            if (!reason) {
                alert('请输入差异原因');
                return;
            }
            if (!solution) {
                alert('请输入处理方案');
                return;
            }
            
            // 保存处理记录
            const handlingRecord = {
                assetCode,
                diff,
                reason,
                solution,
                handler,
                status,
                handledAt: new Date().toISOString()
            };
            
            localStorage.setItem(`discrepancy_${assetCode}_${currentPlanId}`, JSON.stringify(handlingRecord));
            
            // 关闭模态框
            closeModal();
            
            // 刷新分析表格
            loadAnalysisData();
            
            showAlert('差异处理结果已保存', 'success');
        }

        // 页面加载时的初始化
        window.onload = function() {
            // 清除编辑状态
            localStorage.removeItem('editingInventoryPlanId');
            
            // 加载盘点计划列表
            loadInventoryPlans();
        };
    </script>
</body>
</html>